<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="icon" href="./assets/Emerginov.ico" />
  <!-- 2 load the theme CSS file -->
  <link rel="stylesheet" href="plugin/codemirror/addon/display/fullscreen.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
  <title>Editeur</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
  <script src="plugin/codemirror/lib/codemirror.js"></script>
  <!--<script src="plugin/Codemirror/addon/comment/comment.js"></script>
  <script src="plugin/Codemirror/addon/display/fullscreen.js"></script>-->
  <script src="plugin/codemirror/addon/hint/show-hint.js"></script>
  <script src="plugin/codemirror/addon/hint/anyword-hint.js"></script>
  <script src="plugin/codemirror/addon/hint/html-hint.js"></script>
  <script src="plugin/codemirror/addon/hint/javascript-hint.js"></script>
  <script src="plugin/codemirror/addon/hint/css-hint.js"></script>
  <link rel="stylesheet" href="plugin/codemirror/addon/hint/show-hint.css"/>
  <link rel="stylesheet" href="plugin/codemirror/lib/codemirror.css"/>
  <script src="plugin/codemirror/mode/xml/xml.js"></script>
  <script src="plugin/codemirror/mode/htmlmixed/htmlmixed.js"></script>
  <script src="plugin/codemirror/mode/php/php.js"></script>
  <script src="plugin/codemirror/mode/clike/clike.js"></script>
  <script src="plugin/codemirror/mode/javascript/javascript.js"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
  <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
  <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>
  <link rel="stylesheet" href="plugin/codemirror/theme/dracula.css"/>
  <link rel="stylesheet" href="plugin/codemirror/theme/blackboard.css"/>
  <link rel="stylesheet" href="plugin/codemirror/theme/xq-dark.css"/>

<style>
   body {font-size:12.5px;}
   *{
    padding: 0;
    margin: 0;
   }
   #chatBox{
     background: white;
   }
   .main{
    background: #DDDCDB;
    width: 100%;
    height: 100%;
    display: inline-flex;
   }
   .bs-example{
    margin: 20px;
   }
   #viewer{
    background: white;
    margin: 30px;
    margin-left: 100px;
    margin-top: -30px;
    width: 100%;
    resize: vertical;
    border: 1px solid #3498db
   }
   #editor-textarea
   {height: 100%;}
   #X,#Y,#Z,#T,#U
   {
    visibility: hidden;}
  .center-div {
    margin: 0 auto;
    width: 100px;}
  .tree :first-child {
    width: 30px;}
  .nav{
    background: #DDDCDB;}
  .CodeMirror-activeline-background {
    background-color:#F0E68C;
  }
}</style>
</head>

<body>
<div   class="main">
  <nav class="navbar navbar-light" style="margin-top: -10px;">

    <button style="margin-left: -20px;"  type="button" class="text-light bg-dark btn-lg" disabled>Emerginov Editor</button>
    <button id="run" style="margin-left: 195px;"   type="button" class="btn btn-primary">Run</button>

    <button onclick="save()" type="button"  class="btn btn-success">Save As</button>
    <input id="toggle-event"  type="checkbox" checked data-toggle="toggle" data-on="Num" data-off=" NO Num" data-onstyle="warning" data-offstyle="info">


    <!--Choice of language-->
    <select id="lang" onchange="myFunction()" class="mdb-select md-form ">
      <option value="1" selected>Html</option>
      <option value="2"   >Javascript</option>
      <option value="3">Python</option>
      <option value="4" >PHP</option>

    </select>

    <div style="margin-left: 440px;" class="btn-group btn-group-toggle" data-toggle="buttons">
      <label class="btn btn-secondary" onclick="theme3()">
        <input type="radio" name="options" id="option2" autocomplete="off" checked> The Dark
      </label>

      <label class="btn btn-secondary" onclick="theme2()">
        <input type="radio" name="options" id="option3" autocomplete="off"> BlackBoard
      </label>
      <label class="btn btn-secondary" onclick="theme1()">
        <input type="radio" name="options" id="option1"  autocomplete="off" > Dracula
      </label>
      <label class="btn btn-secondary active" onclick="theme0()" >
        <input type="radio" name="options" id="option0"  autocomplete="off"> Default
      </label>
      <button  type="button" class="btn btn-danger">Back</button>

    </div></div></nav>


<!--<button type="button" class="btn btn-warning">Warning</button>
<button type="button" class="btn btn-info">Info</button>
<button type="button" class="btn btn-light">Light</button>
<button type="button" class="btn btn-dark">Dark</button>-->

<div class="main">
  <button  type="button" class="text-light bg-danger btn-lg" disabled>Your project</button>

</div>

<div class="main">
   <!-- div for the tree-->
    <div class="tree" id="jstree"></div>
    <div style="margin-top:450px;">
        <button  style="margin-top:-50px; margin-left:100px"type="button" class="text-light bg-dark btn" disabled>Live Chat</button>
        <button  style="margin-left:0px" class="btn btn-success" onclick="RefreshSlack()">refresh conversation</button><button style="margin-left:0px" class="btn btn-danger" onclick="CleanConversation()">Clean the chat</button>

        <iframe height="200px" width="300px" id="chatBox" ></iframe>

        <div style="margin-top: 10px;" >
          <input id="inputSlack"  name="" type="text" placeholder="put a message here"><input  onclick="putMastodonMessage()" type="submit">
       </div>
        <img style="margin-left:90px;margin-top:10px" src="./assets/slack.png" width="100px" alt="" />
    </div>

   <!--div for the editor-->
    <div  style="margin-top: -50px;margin-left: 50px;">
    <textarea  id="editor-textarea"   placeholder="Put your code here !" onkeyup =""></textarea></div>
    <div class="bd-example">
      <div class="btn-group-vertical btn-group-sm " role="group" aria-label="Vertical button group">
         <button id="X" onclick="step_by_step()"  type="button" class="btn btn-secondary">By Step</button>
         <button id="Y" onclick="Resume()"      id="Y" type="button" class="btn btn-secondary">Next</button>
         <button id="Z" onclick="removeAll()" type="button" class="btn btn-secondary">RemoveAll </button>
         <button id="T" onclick="hideAll()" type="button" class="btn btn-secondary">Hide </button>
         <button id="U" onclick="showAll()" type="button" class="btn btn-secondary">Show All</button>
      </div>
    </div>
   <!-- div for the viewer-->
    <iframe  id="viewer"></iframe>
</div>


 <p id="demo"></p>
<!-- include the minified jstree source -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
<script>

   //create an instance of editor using Codemirror and set some options
   var editor=CodeMirror.fromTextArea(document.getElementById('editor-textarea'),
   {
     mode:"application/x-httpd-php",
     dragDrop:true,
     indentWithTabs: true,
     autocorrect:true,
     lineNumbers:true,
     autoCloseBrackets: true,
     extraKeys: {"Ctrl-Space":"autocomplete"},
     gutters: ["CodeMirror-linenumbers", "breakpoints"]
   });
   var m=0;

 var infos=[];
 var memory =[];
 var highlightedLine=[]

editor.on("gutterClick", function (cm, n) {
 var BreakpointsOnlyifEmpty="";
 var info = cm.lineInfo(n);
 var infoLine=info.line;
 var textContent=editor.getRange({line:n, ch:0},{line:n+1, ch:0});
 BreakpointsOnlyifEmpty=textContent;
 console.log(info);
 if (info.gutterMarkers!=null) {
   var line=info.line ;
   let i=0;
   while (infos[i]!=line && i<infos.length){
     i=i+1;
   }
   infos.splice(i,1);
   cm.setGutterMarker(n, "breakpoints", info.gutterMarkers ? null : null);

   console.log(infos);
 }else{
   if (BreakpointsOnlyifEmpty.length>1 && BreakpointsOnlyifEmpty!="") {
     infos.push(infoLine);
     infos.sort((a, b) => a - b);
     console.log(infos);
    /* var textContent=editor.getRange({line:0, ch:0},{line:infos[0]+1, ch:0});
     console.log(textContent)*/
     cm.setGutterMarker(n, "breakpoints", info.gutterMarkers ? null : makeMarker());

   }


 }
 //info.textbeforeLine=textContent;
 info.tableau=infos;
 console.log(info)

});

function removeAll(){
 for(var k of VisibleMap.keys()){
 for (var i = 0; i < VisibleMap.get(k).length; i++) {
    editor.setGutterMarker(VisibleMap.get(k)[i], "breakpoints",  null);
  }
 }
 for(var k of InvisibleMap.keys()){
  for (var i = 0; i < InvisibleMap.get(k).length; i++) {
    editor.setGutterMarker(InvisibleMap.get(k)[i], "breakpoints",  null);
  }
 }
 for (var i=0;i<infos.length;i++){
  editor.setGutterMarker(infos[i], "breakpoints", null);
     }
 for (var i=0;i<memory.length;i++){
  editor.setGutterMarker(memory[i], "breakpoints", null);
 }
 VisibleMap.clear();
 InvisibleMap.clear();
 infos=[];
 memory=[];
 setVisibility();

}

function hideAll(){
  let new_path=localStorage.getItem('selected_path');
  console.log(new_path);
  if (infos.length!=0) {
    if (VisibleMap.get(new_path)==null) {
      VisibleMap.set(new_path,infos);
    }else {
      for (var i = 0; i < infos.length; i++) {
        VisibleMap.get(new_path).push(infos[i]);
        VisibleMap.get(new_path).sort((a, b) => a - b);
      }
    }

  }
    if (VisibleMap.size!=0) {
      for (var k of VisibleMap.keys()) {
        if (k==new_path) {
          for (var i = 0; i < VisibleMap.get(k).length; i++) {
            editor.setGutterMarker(VisibleMap.get(k)[i], "breakpoints",  hideMarker());
          }
          if (InvisibleMap.get(k)==null) {
            InvisibleMap.set(k,VisibleMap.get(k));
          }else {
            for ( var i=0;i<VisibleMap.get(k).length;i++){
              InvisibleMap.get(k).push(VisibleMap.get(k)[i]);
              InvisibleMap.get(k).sort((a, b) => a - b);
            }
          }

          VisibleMap.delete(k);

        }
        console.log(infos);
      }

    }else{
      for (var i=0;i<infos.length;i++){
       editor.setGutterMarker(infos[i], "breakpoints",  hideMarker());
       memory.push(infos[i]);
           }
       InvisibleMap.set(new_path,infos);
    }

console.log(infos);


 infos=[];
  for(var i=0 ;i<highlightedLine.length;i++){
    editor.removeLineClass(highlightedLine[i], 'wrap', 'CodeMirror-activeline-background');

   }
 highlightedLine=[];
}


function checkInclusion (superset, subset) {
 if (0 === subset.length) {
   return false;
 }
 return subset.every(function (value) {
   return (superset.indexOf(value) >= 0);
 });
}

function show(BreakpointsInvisible,BreakpointsVisible){
   if (BreakpointsInvisible!=null || BreakpointsVisible!=null) {
     for (var i = 0; i < BreakpointsVisible.length; i++) {
       editor.setGutterMarker(BreakpointsVisible[i], "breakpoints",  makeMarker());
     }
     for (var i = 0; i < BreakpointsInvisible.length; i++) {
      editor.setGutterMarker(BreakpointsInvisible[i], "breakpoints",  hideMarker());
     }
   }

 }

function showAll(){
 let new_path=localStorage.getItem('selected_path');
 if (InvisibleMap.size!=0) {
   for(var k1 of InvisibleMap.keys()){
     if (k1==new_path) {
       for (var i = 0; i < InvisibleMap.get(k1).length; i++) {
         editor.setGutterMarker(InvisibleMap.get(k1)[i], "breakpoints",  makeMarker());
       }
     }
     VisibleMap.set(k1,InvisibleMap.get(k1));
     InvisibleMap.delete(k1)
   }
 }else {
   if (!checkInclusion(infos,memory)) {
    for (var i=0;i<memory.length;i++){
     editor.setGutterMarker(memory[i], "breakpoints",  makeMarker());
     infos.push(memory[i]);
     infos.sort((a, b) => a - b);
    }
   }

 }
 for (var i=0;i<infos.length;i++){
        editor.setGutterMarker(infos[i], "breakpoints",  makeMarker());
 }
 for(var i=0 ;i<highlightedLine.length;i++){
    editor.removeLineClass(highlightedLine[i], 'wrap', 'CodeMirror-activeline-background');
 }
 highlightedLine=[];
 memory=[];
}

editor.on("gutterClick", function(cm, n) {
 var info = cm.lineInfo(n);
 //info.textbeforeLine=textContent;
 console.log("done");

 console.log(editor);
 setVisibility();

});

function setVisibility(){
 var button1 = document.getElementById("X");
 var button2 = document.getElementById("Y");
 var button3 = document.getElementById("Z");
 var button4 = document.getElementById("T");
 var button5 = document.getElementById("U");

 if (infos.length!=0) {
   button1.style.visibility="visible";
   button2.style.visibility="visible";
   button3.style.visibility="visible";
   button4.style.visibility="visible";
   button5.style.visibility="visible";

 }else{
   button1.style.visibility="hidden";
   button2.style.visibility="hidden";
   button3.style.visibility="hidden";
   button4.style.visibility="hidden";
   button5.style.visibility="hidden";
    for(var i=0 ;i<highlightedLine.length;i++){
    editor.removeLineClass(highlightedLine[i], 'wrap', 'CodeMirror-activeline-background');

   }
   highlightedLine=[];



 }
 }

function step_by_step() {
   let new_path=localStorage.getItem('selected_path');
   if (infos.length==0) {
     length=highlightedLine.length;
     if(length!=0){
       editor.removeLineClass(highlightedLine[length-1], 'wrap', 'CodeMirror-activeline-background');
       console.log(highlightedLine)
       editor.addLineClass(highlightedLine[length-1]+1, 'wrap', 'CodeMirror-activeline-background');
       highlightedLine.push(highlightedLine[length-1]+1);
       console.log(highlightedLine);
     }else{
       editor.addLineClass(VisibleMap.get(new_path)[0], 'wrap', 'CodeMirror-activeline-background');
       highlightedLine.push(VisibleMap.get(new_path)[0]);
       console.log(highlightedLine);
     }
     //infos=VisibleMap.get(new_path);
   }else {
     console.log(infos);
     console.log(highlightedLine);
     length=highlightedLine.length;
     if(length!=0){
       editor.removeLineClass(highlightedLine[length-1], 'wrap', 'CodeMirror-activeline-background');
       console.log(highlightedLine)
       editor.addLineClass(highlightedLine[length-1]+1, 'wrap', 'CodeMirror-activeline-background');
       highlightedLine.push(highlightedLine[length-1]+1);
       console.log(highlightedLine);
     }else{
       editor.addLineClass(infos[0], 'wrap', 'CodeMirror-activeline-background');
       highlightedLine.push(infos[0]);
       console.log(highlightedLine);
     }
   }

}

function Resume() {
  let new_path=localStorage.getItem('selected_path');

  if (infos.length==0) {
    var j=0;
    console.log(highlightedLine);
  if (highlightedLine.length>0) {
    console.log(highlightedLine);
   while (j<=highlightedLine.length-1){
    var i=0;
    while (i<VisibleMap.get(new_path).length && VisibleMap.get(new_path)[i]!=highlightedLine[highlightedLine.length-j-1]){
      i++;
    }
    if (i>=VisibleMap.get(new_path).length) {
      j++;
      console.log(j);
    }else{
      break;
      console.log(infos[i]);
    }
   }
   editor.removeLineClass(highlightedLine[i], 'wrap', 'CodeMirror-activeline-background');
   editor.removeLineClass(highlightedLine[highlightedLine.length-1], 'wrap', 'CodeMirror-activeline-background');
   if (VisibleMap.get(new_path)[i+1]!=null) {
         editor.addLineClass(VisibleMap.get(new_path)[i+1], 'wrap', 'CodeMirror-activeline-background');
         highlightedLine.push(VisibleMap.get(new_path)[i+1]);
         //highlightedLine.splice(0,1);
         console.log(highlightedLine);
      }
  }else{

    editor.addLineClass(VisibleMap.get(new_path)[0], 'wrap', 'CodeMirror-activeline-background');
    highlightedLine.push(VisibleMap.get(new_path)[0]);

  }
  //  infos=VisibleMap.get(new_path);
 }else {
  var j=0;
  console.log(highlightedLine);
  if (highlightedLine.length>0) {
  console.log(highlightedLine);
  while (j<=highlightedLine.length-1){
   var i=0;
   while (i<infos.length && infos[i]!=highlightedLine[highlightedLine.length-j-1]){
    i++;
   }
   if (i>=infos.length) {
    j++;
    console.log(j);
   }else{
    break;
    console.log(infos[i]);
   }
  }
  editor.removeLineClass(highlightedLine[i], 'wrap', 'CodeMirror-activeline-background');
  editor.removeLineClass(highlightedLine[highlightedLine.length-1], 'wrap', 'CodeMirror-activeline-background');
  if (infos[i+1]!=null) {
       editor.addLineClass(infos[i+1], 'wrap', 'CodeMirror-activeline-background');
       highlightedLine.push(infos[i+1]);
       //highlightedLine.splice(0,1);
       console.log(highlightedLine);
    }
  }else{

  editor.addLineClass(infos[0], 'wrap', 'CodeMirror-activeline-background');
  highlightedLine.push(infos[0]);

}}}


function makeMarker() {
 var marker = document.createElement("div");
 marker.style.color = "#822";
 marker.innerHTML = "●";
 marker.style.marginLeft="-26px";
 return marker;


}

function hideMarker() {
 var marker = document.createElement("div");
 marker.style.color = "#6666FF";
 marker.innerHTML = "●";
 marker.style.marginLeft="-26px";
 return marker;


}


    editor.setSize(500, 960);   //set editor size
    CodeMirror.commands.autocomplete = function(cm) {   //use the autocomplete for the editor
     cm.showHint({hint: CodeMirror.hint.anyword});
    }

   function myFunction(){
    var x = document.getElementById("lang").value;
    if  (x=="1") {
     editor.setOption("mode","application/x-httpd-php");
    }if (x=="2") {
     editor.setOption("mode","javascript");
    }if (x=="3") {
     editor.setOption("mode","python");
    }if (x=="4") {
     editor.setOption("mode","php");
    }
   }

   function save() {

      var textContent=editor.getValue();
      var selected_path = localStorage.getItem('selected_path');
      console.log(textContent);
      console.log(selected_path);

      $.ajax({
          async: true,
          type: "POST",
          url: "http://localhost:3000/save",
          dataType:"json",
          data: {
              "code":textContent,
              "path":selected_path
          },
          success: function (json) {
            console.log("done");
            //editor.setValue(json.code);
            //  document.getElementById('viewer').srcdoc=json.response;
          },
          error: function (xhr, ajaxOptions, thrownError) {
            //  alert(xhr.status);
            //  alert(thrownError);
          }
      });};
 //function to set lineNumbers  editor's options
   $(function lineNumbers_Activation() {
    $('#toggle-event').change(function() {
     if ( $(this).prop('checked')) {
      editor.setOption("lineNumbers",true);
     }else{
      editor.setOption("lineNumbers",false);

     }
   })})
  //set the chosen theme in editor's options

 function theme0(){
   editor.setOption("theme","");
  }
 function theme1(){
   editor.setOption("theme","dracula");
 }
 function theme2(){
   editor.setOption("theme","blackboard");
 }
 function theme3(){
   editor.setOption("theme","xq-dark");
 }

   $('#run').click(function sendCode () {
              var textContent=editor.getValue();
            //  console.log(textContent);
              $.ajax({
                  async: true,
                  type: "POST",
                  url: "http://localhost:3000/php",
                  dataType:"json",
                  data: {
                      "code":textContent
                  },
                  success: function (json) {
                      document.getElementById('viewer').srcdoc=json.response;
                  },
                  error: function (xhr, ajaxOptions, thrownError) {
                    //  alert(xhr.status);
                    //  alert(thrownError);
                  }
              });
   });
   $(function () {
              $.ajax({
                  async: true,
                  type: "GET",
                  url: "http://localhost:3000/home/editor",
                  dataType: "json",
                  success: function (json) {
                      create_tree(json);
                  },

                  error: function (xhr, ajaxOptions, thrownError) {
                      alert(xhr.status);
                      alert(thrownError);
                  }
              });
          });
   function create_tree(jsondata){
    //  create an instance with one node
    $('#jstree').jstree({
         "core" : {
           "animation" : 0,
           "check_callback" : true,
           'data' : {
             'data' : function (node) {
                 return { 'id' : node.id };
                }
           },
           "themes" : { "stripes" : true },
           'data' : jsondata
           },
           "types" : {
             "#" : {
                   "max_children" : 1,
                   "max_depth" : 6,              //set max number of children's node
                   "valid_children" : ["root"]
                 },
            "root" : {
              "icon" : "/static/3.3.8/assets/images/tree_icon.png",
                "valid_children" : ["default"]
            },

            "default" : {
                   "valid_children" : ["default","file"]
            },
            "file" : {
                   "icon" : "glyphicon glyphicon-file",
                   "valid_children" : []
                 }
           },
           'contextmenu' : {
            'items' : function(node) {
               var tmp = $.jstree.defaults.contextmenu.items();
               delete tmp.create.action;
               tmp.create.label = "New";
               tmp.create.submenu = {
                 "create_folder" : {
                   "separator_after"	: true,
                   "label"				: "Folder",
                   "action"			: function (data) {
                   var inst = $.jstree.reference(data.reference),
                   obj = inst.get_node(data.reference);
                   inst.create_node(obj, { type : "default" }, "last", function (new_node) {
                       var path=inst.get_path(new_node,'/');
                       var name=inst.get_text();
                       console.log(new_node);
                       new_node.original.path = path;
                       console.log(new_node);

                       $.ajax({
                           async: true,
                           type: "POST",
                           url: "http://localhost:3000/home/project",
                           data: {
                             "path":path,
                             "type":"folder"
                           },
                           success: function (json) {
                           },

                           error: function (xhr, ajaxOptions, thrownError) {
                               alert(thrownError);
                           }
                       });

                       //put("/file/create", {path: "path", type:"file"})
                        setTimeout(function () { inst.edit(new_node); },0);
                     });
                   }
                 },
                 "create_file" : {
                   "label"				: "File",
                   "action"			: function (data) {
                      var inst = $.jstree.reference(data.reference),
                      obj = inst.get_node(data.reference);
                      inst.create_node(obj, { type : "file" }, "last", function (new_node) {
                      var name=inst.get_text();
                      var path=inst.get_path(new_node,'/');
                      new_node.original.path = path;
                      $.ajax({
                          async: true,
                          type: "POST",
                          url: "http://localhost:3000/home/project",
                          data: {
                            "path":path,
                            "type":"file"
                          },
                          success: function (json) {
                            //alert("done");
                          },

                          error: function (xhr, ajaxOptions, thrownError) {
                              alert(thrownError);
                          }

                      });

                      //put("/file/create", {path: "path", type:"file"})
                       setTimeout(function () { inst.edit(new_node); },0);

                     });
                   }
                 }
               };
               if(this.get_type(node) === "file") {
                 delete tmp.create;
               }
               return tmp;
             }
           },
          "plugins" : [
               "contextmenu",  // set the context menu (create/rename/delete nodeds)
               "dnd",          // allow drag and drop
               "search",
               "state",
               "types"
               ]
      });
    }

   var VisibleMap=new Map();
   var InvisibleMap=new Map();

   $('#jstree').on("changed.jstree", function(e, data) {
     var VisibleBreakpointsToLoad=[];
     var InvisibleBreakpointsToLoad=[];
     var type_of_selected=data.node.type == "default" ? "folder" : "file";
     if (type_of_selected=="file") {
       var old_path =localStorage.getItem('selected_path');
       console.log("old_path: "+old_path);
     }
     var new_path = data.node.original.path;
     new_path = new_path.replace(/\/[^\/]*$/, `/${data.node.text}`);
     console.log("new_path: "+new_path);
     if (type_of_selected=="file") {
       localStorage.setItem('selected_path', new_path);
     }
     if (infos.length!=0) {
       if (VisibleMap.get(old_path)==null) {
         VisibleMap.set(old_path,infos);
       }else {
         for (var i=0;i<infos.length;i++){
           VisibleMap.get(old_path).push(infos[i]);
           VisibleMap.get(old_path).sort((a, b) => a - b);
         }
       }
     }
     if (memory.length!=0) {
       InvisibleMap.set(old_path,memory);
     }
     if (type_of_selected=="file") {

     $.ajax({
         async: true,
         type: "POST",
         url: "http://localhost:3000/save/show",
         dataType:"json",
         data:{
           "new_path":new_path,
         },
         success: function (json) {
           //console.log("done");
           editor.setValue(json.code);
           for (var path of VisibleMap.keys()) {
             console.log(VisibleMap);
              if (path==new_path && VisibleMap.get(path).length!=0) {
                  VisibleBreakpointsToLoad=VisibleMap.get(path);
                  console.log(VisibleBreakpointsToLoad);
                  console.log(infos);
              }
           }
           for (var path of InvisibleMap.keys()) {
             console.log(InvisibleMap);
              if (path==new_path && InvisibleMap.get(path).length!=0) {
                  InvisibleBreakpointsToLoad=InvisibleMap.get(path);
                  console.log(InvisibleBreakpointsToLoad);
                  console.log(infos);
              }
           }
           show(InvisibleBreakpointsToLoad,VisibleBreakpointsToLoad)
           infos=[];
           memory=[];
           highlightedLine=[];
         },
         error: function (xhr, ajaxOptions, thrownError) {
           //  alert(xhr.status);
           //  alert(thrownError);
         }
     });}});

   $('#jstree').on('delete_node.jstree', function (e, data) {
         let node = data.node;
         let path = node.original.path;
         let type = node.type == "default" ? "folder" : "file";
         console.log(path);
         //let new_path = old_path.replace(/\/[^\/]*$/, `/${node.text}`)
         if (type=="file") {
           path=localStorage.getItem('selected_path');
         }
       $.ajax({
           async: true,
           type: "DELETE",
           url: "http://localhost:3000/home/project",
           data: {
             "path":path,
             "type":type

           },
           success: function (json) {
             //alert("done");
           },

           error: function (xhr, ajaxOptions, thrownError) {
               alert(thrownError);
           }
       });
      });

   $('#jstree').on('rename_node.jstree', function (e, data) {
        // var inst = $.jstree.reference(data.reference);
        let node = data.node;
        let old_path = node.original.path;
        let new_path = old_path.replace(/\/[^\/]*$/, `/${node.text}`);
        node.original.new_path=new_path;
        console.log(node);
        console.log(new_path);
        $.ajax({
            async: true,
            type: "PUT",
            url: "http://localhost:3000/home/project",
            data: {
              "old_path": old_path,
              "new_path": new_path,
            },
            success: function (json) {
            //  alert("done");
            },

            error: function (xhr, ajaxOptions, thrownError) {
                alert(thrownError);
            }
        });
       });

   $('#jstree').on('move_node.jstree', function (e, data) {
        let node = data.node;
        let newParent=data.parent;
        let newPosition=data.position;
        console.log($('#jstree').jstree(true).get_path(newParent));
        // console.log($('#jstree').get_path(newParent));
        // let old_path = node.original.path;
        // let new_path = old_path.replace(/\/[^\/]*$/, `/${node.text}`)
        // console.log(new_path);
        // $.ajax({
        //     async: true,
        //     type: "PUT",
        //     url: "http://localhost:3000/home/project",
        //     data: {
        //       "old_path": old_path,
        //       "new_path": new_path,
        //     },
        //     success: function (json) {
        //     //  alert("done");
        //     },
        //
        //     error: function (xhr, ajaxOptions, thrownError) {
        //         alert(thrownError);
        //     }
        // });
    	});

      function CleanConversation(){
        document.getElementById('chatBox').srcdoc="";
      }

      function RefreshMastodon(){

        $.ajax({
            async: true,
            type: "POST",
            url: "http://localhost:3000/mastodon",
            data: {

            },
            success: function (json) {
              console.log(json);
              var updateConversation="";
              for (x in json) {
                  updateConversation+=json[x]+"<br>";
                  document.getElementById('chatBox').srcdoc=updateConversation;
                }
              },
              // response=json.msg3+"\n"+json.msg2+"\n"+json.msg1+"\n"+json.msg0;
              // document.getElementById('chatBox').srcdoc+=response;
            error: function (xhr, ajaxOptions, thrownError) {
                alert(thrownError);
            }

        });
      }
      function RefreshSlack(){

        $.ajax({
            async: true,
            type: "POST",
            url: "http://localhost:3000/slack",
            data: {

            },
            success: function (json) {
              console.log(json);
              var updateConversation="";
              for (x in json) {
                  updateConversation+=json[x]+"<br>";
                  document.getElementById('chatBox').srcdoc=updateConversation;
                }
              },
              // response=json.msg3+"\n"+json.msg2+"\n"+json.msg1+"\n"+json.msg0;
              // document.getElementById('chatBox').srcdoc+=response;
            error: function (xhr, ajaxOptions, thrownError) {
                alert(thrownError);
            }

        });
      }
      
      function putMastodonMessage(){
        var value=document.getElementById('inputSlack').value;
        console.log(value);
        $.ajax({
            async: true,
            type: "POST",
            url: "http://localhost:3000/mastodon/send",
            data: {
              "message":value
            },
            success: function (json) {
                  value=json.name+": "+value;
                  document.getElementById('chatBox').srcdoc+="<br>"+value;
              },
              // response=json.msg3+"\n"+json.msg2+"\n"+json.msg1+"\n"+json.msg0;
              // document.getElementById('chatBox').srcdoc+=response;
            error: function (xhr, ajaxOptions, thrownError) {
                alert(thrownError);
            }

        });
      }
      function putSlackMessage(){
        var value=document.getElementById('inputSlack').value;
        console.log(value);
        $.ajax({
            async: true,
            type: "POST",
            url: "http://localhost:3000/slack/send",
            data: {
              "message":value
            },
            success: function (json) {
                  value=json.name+": "+value;
                  document.getElementById('chatBox').srcdoc+="<br>"+value;
              },
              // response=json.msg3+"\n"+json.msg2+"\n"+json.msg1+"\n"+json.msg0;
              // document.getElementById('chatBox').srcdoc+=response;
            error: function (xhr, ajaxOptions, thrownError) {
                alert(thrownError);
            }

        });


      }



  </script>
  </body>
  </html>
